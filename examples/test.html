<!DOCTYPE html>
<meta charset="utf-8">
<link href="../src/nv.d3.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="../d3.parcoords.css">
<link rel="stylesheet" type="text/css" href="../d3.parsets.css">
<style>
body,html {
  overflow-y:scroll;
  width: 100%;
  height: 100%;
}

text {
  font: 12px sans-serif;
}

#container {
  margin: 10px;
  min-width: 100px;
  min-height: 100px;
}

</style>
<body>
  <select id="vizType"></select>
  <div id="container" class='with-3d-shadow with-transitions'>
    <svg></svg>
  </div>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="../lib/d3.v3.js"></script>
<script src="../lib/d3.parcoords.js"></script>
<script src="../lib/d3.parsets.js"></script>
<script src="../nv.d3.js"></script>
<!--script src="../src/utils.js"></script>
<script src="../src/tooltip.js"></script>
<script src="../src/models/legend.js"></script>
<script src="../src/models/axis.js"></script>
<script src="../src/models/multiBarHorizontal.js"></script>
<script src="../src/models/multiBarHorizontalChart.js"></script>
<script src="../src/models/multiBar.js"></script>
<script src="../src/models/multiBarChart.js"></script>
<script src="stream_layers.js"></script-->
<script>
var types = ['parallelSets', 'timeBubbles', 'parallelCoordinates', 'scatterChart', 'stackedArea', 'multiBarHorizontalChart', 'multiBarChart'];
types.forEach(function (key) {
  $('#vizType').append($('<option/>').val(key).text(key));
});

d3.csv('OlympicAthletes.csv', function (csv) {
  window.csv = csv;
  render($('#vizType').val());
});

var columnTypes = {
  "Athlete":"string",
  "Age":"number",
  "Country":"string",
  "Year":"number",
  "Closing Ceremony Date":"string",
  "Sport":"string",
  "Gold Medals":"number",
  "Silver Medals":"number",
  "Bronze Medals":"number",
  "Total Medals":"number"
};

function transformData(keys, rollup) {
  var dim2_keys = {};
  var data = d3.nest();
  keys.forEach(function (key) {
    data = data.key(function (d) { return d[key]; }).sortKeys(d3.ascending);
  });
  if (rollup) {
    data = data.rollup(rollup);
  }
  data = data.entries(csv); //.slice(0,2000));

  data.forEach(function (dim1) {
    if (dim1.values instanceof Array) {
      dim1.values.forEach(function (dim2) {
        if (dim2.key) dim2_keys[dim2.key] = 1;
      });
    }
  });
  var keys2 = Object.keys(dim2_keys).sort();
  if (keys2.length > 0) {
    data.forEach(function (dim1) {
      var values = keys2.map(function (key) {
        return {
          key: key,
          values: 0
        };
      });
      if (dim1.values instanceof Array) {
        dim1.values.forEach(function (dim2) {
          var idx = keys2.indexOf(dim2.key);
          if (idx > -1) {
            values[idx].values = dim2.values;
          }
        });
        dim1.values = values;
      }
    });
  }

  return data;
}

function multiBarChart() {
  var chart = nv.models.multiBarChart()
      .x(function(d) { return d.key })
      .y(function(d) { return d.values })
      .margin({top: 30, right: 20, bottom: 50, left: 175})
//        .showValues(false)
      .tooltips(true)
      .transitionDuration(250)
      .stacked(true)
      .showControls(true);

  var data = transformData(['Country', 'Sport'], function (d) { return d3.sum(d, function (g) { return g['Gold Medals']; }); });
  d3.select('#container svg')
      .datum(data)
      .call(chart);

  nv.utils.windowResize(chart.update);

  return chart;
}

function multiBarHorizontalChart() {
  var chart = nv.models.multiBarHorizontalChart()
      .x(function(d) { return d.key })
      .y(function(d) { return d.values })
      .margin({top: 30, right: 20, bottom: 50, left: 175})
//        .showValues(false)
      .tooltips(true)
      .transitionDuration(250)
      .stacked(true)
      .showControls(true);

  var data = transformData(['Country', 'Sport'], function (d) { return d3.sum(d, function (g) { return g['Gold Medals']; }); });
  d3.select('#container svg')
      .datum(data)
      .call(chart);

  nv.utils.windowResize(chart.update);

  return chart;
}

function stackedArea() {
  var data = transformData(['Country', 'Sport'], function (d) { return d3.sum(d, function (g) { return g['Gold Medals']; }); });

  var sports = [];
  data[0].values.forEach(function (o) {
    sports.push(o.key);
  });

  var width = nv.utils.windowSize().width - 100,
      height = nv.utils.windowSize().height - 20;

  var chart = nv.models.stackedAreaChart()
              .width(width)
              .height(height)
              .x(function(d) { return sports.indexOf(d.key); })
              .y(function(d) { return d.values })
//              .offset('wiggle')
//              .order('default')

  chart.xAxis.tickFormat(function(d) { return sports[d]; });

  var svg = d3.select('#container svg')
    .attr('width', width)
    .attr('height', height)
    .datum(data)

  svg.transition().duration(500).call(chart);
  return chart;
}

function findLineByLeastSquares(values_x, values_y) {
  var sum_x = 0;
  var sum_y = 0;
  var sum_xy = 0;
  var sum_xx = 0;
  var count = 0;

  var x = 0;
  var y = 0;
  var values_length = values_x.length;

  if (values_length != values_y.length) {
    throw new Error('The parameters values_x and values_y need to have same size!');
  }

  if (values_length === 0) {
    return [ [], [] ];
  }

  for (var v = 0; v < values_length; v++) {
    x = values_x[v];
    y = values_y[v];
    sum_x += x;
    sum_y += y;
    sum_xx += x*x;
    sum_xy += x*y;
    count++;
  }

  var m = (count*sum_xy - sum_x*sum_y) / (count*sum_xx - sum_x*sum_x);
  var b = (sum_y/count) - (m*sum_x)/count;

  return { m: m, b: b };
}

function parallelCoordinates() {
  $('#container').addClass('parcoords');

  var data = csv;
  var dimensions = Object.keys(csv[0]).filter(function (x) { return !x.match(/Date/); });

  parcoords = d3.parcoords()("#container")
    .alpha(0.4)
    .mode("queue") // progressive rendering
    .height(d3.max([document.body.clientHeight-100, 220]))
    .margin({
      top: 36,
      left: 0,
      right: 0,
      bottom: 16
    });

  parcoords
    .types(columnTypes)
    .dimensions(dimensions)
    .data(data)
    .render()
    .reorderable()
    .brushable();
}

function scatterChart() {
  var rollup = function (d) {
    var measures = ['Gold Medals', 'Silver Medals', 'Bronze Medals', 'Total Medals'];
    var o = {};
    measures.forEach(function (measure) {
      o['Sum ' + measure] = d3.sum(d, function (g) { return +g[measure]; });
      o['Mean ' + measure] = d3.mean(d, function (g) { return +g[measure]; });
    });
    return [o];
  };
  var data = transformData(['Country'], rollup);

  var width = nv.utils.windowSize().width - 100,
      height = nv.utils.windowSize().height - 20;

//  var chart = nv.models.scatterPlusLineChart()
  var chart = nv.models.scatterChart()
              .width(width)
              .height(height)
              .x(function(d) { return +d['Sum Gold Medals'] || 0; })
              .y(function(d) { return +d['Sum Silver Medals'] || 0; })
              .size(function (d) { return +d['Sum Total Medals'] || 0; })
              .useVoronoi(false)
              .showDistX(true)
              .showDistY(true)

    chart.xAxis.tickFormat(d3.format('.0f')).axisLabel('Sum Gold Medals');
    chart.yAxis.tickFormat(d3.format('.0f')).axisLabel('Sum Silver Medals');
    chart.tooltipContent(function(key, x, y, o, fn) {
        return '<h2>' + key + '</h2>';
    });

    // line of best fit
    /*
    var xs=data.map(function (x) { return x.values[0]['Sum Gold Medals']; })
    var ys=data.map(function (x) { return x.values[0]['Sum Silver Medals']; })
    var mb = findLineByLeastSquares(xs, ys);
    data.forEach(function (d) {
      d.slope = 0;
      d.intercept = 0;
    });
    data.push({
      key: 'Regression',
      values: [],
      slope: mb.m,
      intercept: mb.b
    });
    */

  var svg = d3.select('#container svg')
    .attr('width', width)
    .attr('height', height)
    .datum(data)

  svg.transition().duration(500).call(chart);
  return chart;
}

function truncate(str, maxLength, suffix) {
	if(str.length > maxLength) {
		str = str.substring(0, maxLength + 1); 
		str = str.substring(0, Math.min(str.length, str.lastIndexOf(" ")));
		str = str + suffix;
	}
	return str;
}

function parallelSets() {
  var rollup = function (d) {
    var measures = ['Gold Medals', 'Silver Medals', 'Bronze Medals', 'Total Medals'];
    var o = {};
    measures.forEach(function (measure) {
      o['Sum ' + measure] = d3.sum(d, function (g) { return +g[measure]; });
      o['Mean ' + measure] = d3.mean(d, function (g) { return +g[measure]; });
    });
    return [o];
  };
  var data = csv;//transformData(['Country'], rollup);

  var width = nv.utils.windowSize().width;
  var height = nv.utils.windowSize().height - 100;
  var chart = d3.parsets()
  .dimensions(['Year', 'Country'])
  .height(height)
  .width(width);

  var vis = d3.select("#container svg")
      .attr("width", chart.width())
      .attr("height", chart.height() + 50);

  vis.datum(data).call(chart);
}

function timeBubbles() {
  var rollup = function (d) {
    var measures = ['Gold Medals', 'Silver Medals', 'Bronze Medals', 'Total Medals'];
    var o = {};
    measures.forEach(function (measure) {
      o['Sum ' + measure] = d3.sum(d, function (g) { return +g[measure]; });
      o['Mean ' + measure] = d3.mean(d, function (g) { return +g[measure]; });
    });
    return [o];
  };
  var data = transformData(['Country', 'Year'], rollup);
  var measure = 'Sum Gold Medals';

  var margin = {top: 20, right: 200, bottom: 0, left: 20},
    width = nv.utils.windowSize().width - 300,
    height = nv.utils.windowSize().height * 3;

  var yearExtent = d3.extent(csv, function (d) { return +d['Year']; });
  var start_year = yearExtent[0];
  var end_year = yearExtent[1];

  var c = d3.scale.category20c();

  var x = d3.scale.linear()
    .range([0, width]);

  var xAxis = d3.svg.axis()
    .scale(x)
    .orient("top");

  var formatYears = d3.format("0000");
  xAxis.tickFormat(formatYears);

  var svg = d3.select("#container svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .style("margin-left", margin.left + "px")
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	x.domain([start_year, end_year]);
	var xScale = d3.scale.linear()
		.domain([start_year, end_year])
		.range([0, width]);

	svg.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(0," + 0 + ")")
		.call(xAxis);

	for (var j = 0; j < data.length; j++) {
		var g = svg.append("g").attr("class","journal");

		var circles = g.selectAll("circle")
			.data(data[j]['values'])
			.enter()
			.append("circle");

		var text = g.selectAll("text")
			.data(data[j]['values'])
			.enter()
			.append("text");

		var rScale = d3.scale.linear()
      .domain([0, d3.max(data[j]['values'], function(d) {
        return d['values'] instanceof Array ? d['values'][0][measure] : d.values;
      })])
			.range([2, 9]);

		circles
      .attr("cx", function(d, i) {
        return xScale(+d['key']);
      })
			.attr("cy", j*20+20)
      .attr("r", function(d) {
        return rScale(d['values'] instanceof Array ? d['values'][0][measure] : d.values);
       })
			.style("fill", function(d) { return c(j); });

		text
			.attr("y", j*20+25)
      .attr("x",function(d, i) {
        return xScale(+d['key'])-5;
      })
			.attr("class","value")
      .text(function(d){
        return d['values'] instanceof Array ? d['values'][0][measure] : d.values;
      })
			.style("fill", function(d) { return c(j); })
			.style("display","none");

		g.append("text")
			.attr("y", j*20+25)
			.attr("x",width+20)
			.attr("class","label")
			.text(truncate(data[j]['key'],30,"..."))
			.style("fill", function(d) { return c(j); })
			.on("mouseover", mouseover)
			.on("mouseout", mouseout);
	};

	function mouseover(p) {
		var g = d3.select(this).node().parentNode;
		d3.select(g).selectAll("circle").style("display","none");
		d3.select(g).selectAll("text.value").style("display","block");
	}

	function mouseout(p) {
		var g = d3.select(this).node().parentNode;
		d3.select(g).selectAll("circle").style("display","block");
		d3.select(g).selectAll("text.value").style("display","none");
	}
}

function render(type) {
  $('#container svg').empty();
  $('#container canvas').remove();
  var chart;
  nv.addGraph(function() {
    $('#container').removeClass('parcoords');
    var chart = eval(type + '()');
    return chart;
  });
}

$(document).ready(function () {
  $('#vizType').change(function () {
    var type = $(this).val();
    render(type);
  });
});

</script>
